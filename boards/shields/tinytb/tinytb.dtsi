/* TinyTB: PMW3610 (SPI0 3-wire: SDIO=P0.02, SCLK=P0.03, CS=P0.28, MOT=P0.29)
 *        + 4 direct-wired keys on Seeeduino XIAO BLE
 */

#include <zephyr/dt-bindings/gpio/gpio.h>
#include <zephyr/dt-bindings/pinctrl/nrf-pinctrl.h>

/* -------- root -------- */
 / {
	compatible = "zmk,shield-tinytb";

	chosen { zmk,kscan = &kscan0; };

	aliases {
		kscan = &kscan0;
		trackball = &pmw3610;
	};

	/* 4キーをダイレクト配線で取得 */
	kscan0: kscan {
		compatible = "zmk,kscan-gpio-direct";
		label = "TinyTB Keys";

		/* D0=P0.05, D1=P0.04, D2=P1.11, D3=P1.12 */
		input-gpios = <&gpio0  5 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>,  /* D0 */
			      <&gpio0  4 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>,  /* D1 */
			      <&gpio1 11 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>,  /* D2 */
			      <&gpio1 12 (GPIO_PULL_UP | GPIO_ACTIVE_LOW)>;  /* D3 */

		debounce-press-ms = <5>;
		debounce-release-ms = <5>;
	};
};

/* -------- pinctrl (SPI0: SCK=P0.03, SDIO=P0.02) -------- */
&pinctrl {
	spi0_default: spi0_default {
		group1 {
			psels = <NRF_PSEL(SPIM_SCK,  0, 3)>,
				<NRF_PSEL(SPIM_MOSI, 0, 2)>,
				<NRF_PSEL(SPIM_MISO, 0, 2)>; /* MOSI/MISOを同じP0.02に */
		};
	};

	spi0_sleep: spi0_sleep {
		group1 {
			psels = <NRF_PSEL(SPIM_SCK,  0, 3)>,
				<NRF_PSEL(SPIM_MOSI, 0, 2)>,
				<NRF_PSEL(SPIM_MISO, 0, 2)>;
			low-power-enable;
		};
	};
};

/* -------- SPI0 + PMW3610 (3-wire) -------- */
&spi0 {
	status = "okay";

	/* 必須: pinctrl を付与 */
	pinctrl-0 = <&spi0_default>;
	pinctrl-1 = <&spi0_sleep>;
	pinctrl-names = "default", "sleep";

	/* ★3線式（SDIO共有） */
	spi-3wire;

	/* CS は P0.28（NCS） */
	cs-gpios = <&gpio0 28 GPIO_ACTIVE_LOW>;

	/* Trackball: PMW3610 on CS0, MOT=P0.29 */
	pmw3610: pmw3610@0 {
		compatible = "pixart,pmw3610";
		reg = <0>;
		spi-max-frequency = <2000000>;

		irq-gpios = <&gpio0 29 GPIO_ACTIVE_LOW>;
		evt-type = "pointer";

		/* 必要に応じて設定可能
		 * cpi = <1600>;
		 */
	};
};
