#include <dt-bindings/zmk/matrix_transform.h>
#include <zephyr/dt-bindings/input/input-event-codes.h>

/ {
    chosen {
        /* ZMK が参照する KSCAN / 変換 を明示 */
        zmk,kscan = &kscan0;
        zmk,matrix_transform = &tinytb_transform;
    };
};

/* ---- 1x4 の行列変換 ---- */
tinytb_transform: keymap_transform_0 {
    compatible = "zmk,matrix-transform";
    rows = <1>;
    columns = <4>;
    map = <
        RC(0,0) RC(0,1) RC(0,2) RC(0,3)
    >;
};

/* ---- 4キー直結スキャン ---- */
kscan0: kscan {
    compatible = "zmk,kscan-gpio-direct";
    label = "KSCAN";
    input-gpios =
        <&gpio0 28 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>,
        <&gpio0 29 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>,
        <&gpio1 11 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>,
        <&gpio1 12 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
};

/* ---- SPI0 に PMW3610（PixArt）を接続 ---- */
&spi0 {
    status = "okay";
    compatible = "nordic,nrf-spim";
    /* XIAO BLE 既定のピン定義を踏襲（Zephyr ボード側に存在） */
    cs-gpios = <&gpio0 3 GPIO_ACTIVE_LOW>;

    trackball: pmw3610@0 {
        compatible = "pixart,pmw3610";
        status = "okay";
        reg = <0>;
        spi-max-frequency = <2000000>;
        irq-gpios = <&gpio0 2 (GPIO_ACTIVE_LOW | GPIO_PULL_UP)>;
        cpi = <600>;

        /* 相対入力（カーソル移動） */
        evt-type = <INPUT_EV_REL>;
        x-input-code = <INPUT_REL_X>;
        y-input-code = <INPUT_REL_Y>;
    };
};

/* ---- 入力リスナー：定義のみ（有効化・プロセッサ付与は keymap 側でも可） ---- */
 / {
    trackball_listener: trackball_listener {
        compatible = "zmk,input-listener";
        status = "disabled";
        device = <&trackball>;
    };
};
